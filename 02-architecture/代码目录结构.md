# XTrendAI ä»£ç ç›®å½•ç»“æ„ v2.2

## 1. é¡¹ç›®æ ¹ç›®å½•ç»“æ„

```
XTrendAI/
â”œâ”€â”€ app/                          # Next.js App Router (é¡µé¢+API)
â”‚   â”œâ”€â”€ [locale]/                 # å›½é™…åŒ–è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ (main)/               # ä¸»é¡µé¢ç»„ (ä¸å«å¸ƒå±€å‰ç¼€)
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx          # é¦–é¡µ (/ æˆ– /zh-CN æˆ– /en-US)
â”‚   â”‚   â”‚   â”œâ”€â”€ profile/          # ç”¨æˆ·é…ç½®é¡µé¢
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx      # /profile
â”‚   â”‚   â”‚   â”œâ”€â”€ results/          # çƒ­ç‚¹ç»“æœé¡µé¢
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx      # /results
â”‚   â”‚   â”‚   â””â”€â”€ layout.tsx        # ä¸»é¡µé¢ç»„å¸ƒå±€
â”‚   â”‚   â””â”€â”€ api/                  # APIè·¯ç”± (ä¸éœ€è¦localeå‰ç¼€)
â”‚   â”‚       â”œâ”€â”€ trends/           # çƒ­ç‚¹ç›¸å…³API
â”‚   â”‚       â”‚   â””â”€â”€ route.ts      # GET /api/trends
â”‚   â”‚       â”œâ”€â”€ tasks/            # ä»»åŠ¡ç›¸å…³API
â”‚   â”‚       â”‚   â””â”€â”€ route.ts      # POST /api/tasks
â”‚   â”‚       â”œâ”€â”€ user/             # ç”¨æˆ·ç›¸å…³API
â”‚   â”‚       â”‚   â”œâ”€â”€ profile/route.ts  # GET/PUT /api/user/profile
â”‚   â”‚       â”‚   â””â”€â”€ quota/route.ts    # GET /api/user/quota
â”‚   â”‚       â”œâ”€â”€ auth/             # è®¤è¯ç›¸å…³API
â”‚   â”‚       â”‚   â””â”€â”€ route.ts      # POST /api/auth/login
â”‚   â”‚       â””â”€â”€ i18n/             # å›½é™…åŒ–ç›¸å…³API
â”‚   â”‚           â””â”€â”€ route.ts      # POST /api/i18n/language
â”‚   â”œâ”€â”€ layout.tsx                # æ ¹å¸ƒå±€
â”‚   â””â”€â”€ globals.css               # å…¨å±€æ ·å¼
â”‚
â”œâ”€â”€ components/                   # Reactç»„ä»¶
â”‚   â”œâ”€â”€ ui/                       # shadcn/uiåŸºç¡€ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ button.tsx
â”‚   â”‚   â”œâ”€â”€ card.tsx
â”‚   â”‚   â”œâ”€â”€ dialog.tsx
â”‚   â”‚   â”œâ”€â”€ select.tsx
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ layout/                   # å¸ƒå±€ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ Header.tsx            # é¡¶éƒ¨å¯¼èˆªæ 
â”‚   â”‚   â”œâ”€â”€ Footer.tsx            # åº•éƒ¨
â”‚   â”‚   â”œâ”€â”€ LanguageSelector.tsx  # è¯­è¨€åˆ‡æ¢å™¨
â”‚   â”‚   â””â”€â”€ Sidebar.tsx           # ä¾§è¾¹æ (å¯é€‰)
â”‚   â”œâ”€â”€ hotspot/                  # çƒ­ç‚¹ç›¸å…³ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ HotspotList.tsx       # çƒ­ç‚¹åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ HotspotCard.tsx       # å•ä¸ªçƒ­ç‚¹å¡ç‰‡
â”‚   â”‚   â”œâ”€â”€ TaskList.tsx          # ä»»åŠ¡åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ TaskCard.tsx          # å•ä¸ªä»»åŠ¡å¡ç‰‡
â”‚   â”‚   â””â”€â”€ CopyButton.tsx        # å¤åˆ¶æŒ‰é’®
â”‚   â”œâ”€â”€ profile/                  # ç”¨æˆ·é…ç½®ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ ProfileForm.tsx       # é…ç½®è¡¨å•
â”‚   â”‚   â”œâ”€â”€ ProfileStepper.tsx    # é…ç½®å‘å¯¼
â”‚   â”‚   â”œâ”€â”€ LanguageStep.tsx      # è¯­è¨€é€‰æ‹©æ­¥éª¤
â”‚   â”‚   â”œâ”€â”€ RegionSelector.tsx    # åœ°åŒºé€‰æ‹©å™¨
â”‚   â”‚   â”œâ”€â”€ AgeSelector.tsx       # å¹´é¾„é€‰æ‹©å™¨
â”‚   â”‚   â””â”€â”€ ScenarioSelector.tsx  # åœºæ™¯é€‰æ‹©å™¨
â”‚   â””â”€â”€ common/                   # é€šç”¨ç»„ä»¶
â”‚       â”œâ”€â”€ LoadingSpinner.tsx    # åŠ è½½åŠ¨ç”»
â”‚       â”œâ”€â”€ ErrorMessage.tsx      # é”™è¯¯æç¤º
â”‚       â”œâ”€â”€ EmptyState.tsx        # ç©ºçŠ¶æ€
â”‚       â””â”€â”€ Toast.tsx             # æç¤ºæ¶ˆæ¯
â”‚
â”œâ”€â”€ lib/                          # å·¥å…·å‡½æ•°å’Œé…ç½®
â”‚   â”œâ”€â”€ utils.ts                  # é€šç”¨å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ constants.ts              # å¸¸é‡å®šä¹‰
â”‚   â”œâ”€â”€ validation.ts             # æ•°æ®éªŒè¯schema (Zod)
â”‚   â””â”€â”€ format.ts                 # æ ¼å¼åŒ–å‡½æ•°
â”‚
â”œâ”€â”€ locales/                      # å›½é™…åŒ–ç¿»è¯‘èµ„æº
â”‚   â”œâ”€â”€ zh-CN.json                # ä¸­æ–‡ç¿»è¯‘
â”‚   â”‚   {
â”‚   â”‚     "common": {...},
â”‚   â”‚     "home": {...},
â”‚   â”‚     "profile": {...},
â”‚   â”‚     "templates": {...}  # ä»»åŠ¡æ¨¡æ¿
â”‚   â”‚   }
â”‚   â””â”€â”€ en-US.json                # è‹±æ–‡ç¿»è¯‘
â”‚       {
â”‚         "common": {...},
â”‚         "home": {...},
â”‚         "profile": {...},
â”‚         "templates": {...}  # Task templates
â”‚       }
â”‚
â”œâ”€â”€ services/                     # ä¸šåŠ¡æœåŠ¡å±‚
â”‚   â”œâ”€â”€ TrendService.ts           # çƒ­ç‚¹é‡‡é›†æœåŠ¡ (è°ƒç”¨Wrapper)
â”‚   â”œâ”€â”€ FilterService.ts          # ç­›é€‰æœåŠ¡
â”‚   â”œâ”€â”€ TaskService.ts            # ä»»åŠ¡ç”ŸæˆæœåŠ¡
â”‚   â”œâ”€â”€ UserService.ts            # ç”¨æˆ·æœåŠ¡
â”‚   â”œâ”€â”€ QuotaService.ts           # é…é¢ç®¡ç†æœåŠ¡
â”‚   â”œâ”€â”€ AuthService.ts            # è®¤è¯æœåŠ¡
â”‚   â”œâ”€â”€ TemplateService.ts        # æ¨¡æ¿ç®¡ç†æœåŠ¡
â”‚   â””â”€â”€ I18nService.ts            # å›½é™…åŒ–æœåŠ¡
â”‚
â”œâ”€â”€ wrappers/                     # ç¬¬ä¸‰æ–¹æ¥å£å°è£…å±‚ (æ–°å¢)
â”‚   â”œâ”€â”€ BaseWrapper.ts            # åŸºç¡€å°è£…ç±» (é‡è¯•ã€é™æµã€æ—¥å¿—)
â”‚   â”œâ”€â”€ XApiWrapper.ts            # X(Twitter) APIå°è£…
â”‚   â”œâ”€â”€ MCPWrapper.ts             # MCPæœåŠ¡å°è£…
â”‚   â”œâ”€â”€ MockWrapper.ts            # æ¨¡æ‹Ÿæ•°æ®å°è£… (MVPé˜¶æ®µ)
â”‚   â””â”€â”€ index.ts                  # ç»Ÿä¸€å¯¼å‡º
â”‚
â”œâ”€â”€ stores/                       # æ•°æ®å­˜å‚¨å±‚ (MVPé˜¶æ®µ)
â”‚   â”œâ”€â”€ UserStore.ts              # ç”¨æˆ·æ•°æ®å­˜å‚¨
â”‚   â”œâ”€â”€ TrendStore.ts             # çƒ­ç‚¹æ•°æ®å­˜å‚¨
â”‚   â”œâ”€â”€ TemplateStore.ts          # æ¨¡æ¿å­˜å‚¨
â”‚   â””â”€â”€ QuotaStore.ts             # é…é¢æ•°æ®å­˜å‚¨
â”‚
â”œâ”€â”€ types/                        # TypeScriptç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ user.ts                   # ç”¨æˆ·ç›¸å…³ç±»å‹
â”‚   â”œâ”€â”€ trend.ts                  # çƒ­ç‚¹ç›¸å…³ç±»å‹
â”‚   â”œâ”€â”€ task.ts                   # ä»»åŠ¡ç›¸å…³ç±»å‹
â”‚   â”œâ”€â”€ i18n.ts                   # å›½é™…åŒ–ç›¸å…³ç±»å‹
â”‚   â”œâ”€â”€ api.ts                    # APIè¯·æ±‚/å“åº”ç±»å‹
â”‚   â””â”€â”€ index.ts                  # ç»Ÿä¸€å¯¼å‡º
â”‚
â”œâ”€â”€ data/                         # é™æ€æ•°æ® (MVPé˜¶æ®µ)
â”‚   â”œâ”€â”€ mock-trends.json          # æ¨¡æ‹Ÿçƒ­ç‚¹æ•°æ®
â”‚   â”œâ”€â”€ templates.json            # ä»»åŠ¡æ¨¡æ¿
â”‚   â””â”€â”€ regions.json              # åœ°åŒºé…ç½®
â”‚
â”œâ”€â”€ hooks/                        # è‡ªå®šä¹‰React Hooks
â”‚   â”œâ”€â”€ useTrends.ts              # çƒ­ç‚¹æ•°æ®Hook
â”‚   â”œâ”€â”€ useUser.ts                # ç”¨æˆ·æ•°æ®Hook
â”‚   â”œâ”€â”€ useQuota.ts               # é…é¢Hook
â”‚   â”œâ”€â”€ useCopy.ts                # å¤åˆ¶åŠŸèƒ½Hook
â”‚   â”œâ”€â”€ useToast.ts               # æç¤ºæ¶ˆæ¯Hook
â”‚   â””â”€â”€ useI18n.ts                # å›½é™…åŒ–Hook
â”‚
â”œâ”€â”€ middleware/                   # ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ auth.ts                   # é‰´æƒä¸­é—´ä»¶
â”‚   â”œâ”€â”€ quota.ts                  # é…é¢æ£€æŸ¥ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ i18n.ts                   # å›½é™…åŒ–ä¸­é—´ä»¶
â”‚   â””â”€â”€ logger.ts                 # æ—¥å¿—ä¸­é—´ä»¶
â”‚
â”œâ”€â”€ config/                       # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ site.ts                   # ç½‘ç«™é…ç½®
â”‚   â”œâ”€â”€ i18n.ts                   # å›½é™…åŒ–é…ç½®
â”‚   â”œâ”€â”€ scenarios.ts              # åœºæ™¯é…ç½®
â”‚   â””â”€â”€ quotas.ts                 # é…é¢é…ç½®
â”‚
â”œâ”€â”€ public/                       # é™æ€èµ„æº
â”‚   â”œâ”€â”€ icons/                    # å›¾æ ‡
â”‚   â”œâ”€â”€ images/                   # å›¾ç‰‡
â”‚   â””â”€â”€ favicon.ico
â”‚
â”œâ”€â”€ .env.local                    # æœ¬åœ°ç¯å¢ƒå˜é‡
â”œâ”€â”€ .env.example                  # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ .gitignore                    # Gitå¿½ç•¥æ–‡ä»¶
â”œâ”€â”€ next.config.js                # Next.jsé…ç½® (å«i18né…ç½®)
â”œâ”€â”€ tailwind.config.ts            # Tailwindé…ç½®
â”œâ”€â”€ tsconfig.json                 # TypeScripté…ç½®
â”œâ”€â”€ package.json                  # é¡¹ç›®ä¾èµ–
â””â”€â”€ README.md                     # é¡¹ç›®è¯´æ˜
```

---

## 2. æ ¸å¿ƒç›®å½•è¯´æ˜

### 2.1 app/[locale]/ - å›½é™…åŒ–è·¯ç”±

é‡‡ç”¨Next.js 15çš„åŠ¨æ€è·¯ç”±å®ç°å›½é™…åŒ–ï¼š

```
app/
â”œâ”€â”€ [locale]/           # åŠ¨æ€è¯­è¨€è·¯ç”±
â”‚   â”œâ”€â”€ page.tsx        # / â†’ è‡ªåŠ¨é‡å®šå‘åˆ° /zh-CN æˆ– /en-US
â”‚   â”œâ”€â”€ profile/        # /zh-CN/profile, /en-US/profile
â”‚   â””â”€â”€ api/            # APIä¸éœ€è¦localeå‰ç¼€
â”‚       â””â”€â”€ ...
â””â”€â”€ layout.tsx          # æ ¹å¸ƒå±€ï¼Œå¤„ç†è¯­è¨€æ£€æµ‹å’Œé‡å®šå‘
```

**è·¯ç”±æ˜ å°„**:

| è®¿é—®URL | å®é™…æ¸²æŸ“ | è¯´æ˜ |
|---------|---------|------|
| `/` | é‡å®šå‘ | æ ¹æ®æµè§ˆå™¨è¯­è¨€é‡å®šå‘ |
| `/zh-CN` | ä¸­æ–‡é¦–é¡µ | ä¸­æ–‡ç•Œé¢ |
| `/en-US` | è‹±æ–‡é¦–é¡µ | è‹±æ–‡ç•Œé¢ |
| `/api/*` | APIè·¯ç”± | ä¸å—å›½é™…åŒ–å½±å“ |

### 2.2 locales/ - ç¿»è¯‘èµ„æº

ç¿»è¯‘æ–‡ä»¶ç»“æ„ç¤ºä¾‹ï¼š

```json
// locales/zh-CN.json
{
  "common": {
    "appName": "XTrendAI",
    "loading": "åŠ è½½ä¸­...",
    "error": "å‡ºé”™äº†",
    "copy": "å¤åˆ¶",
    "copied": "å·²å¤åˆ¶"
  },
  "home": {
    "title": "ä»Šæ—¥çƒ­ç‚¹",
    "fetchTrends": "è·å–æœ€æ–°çƒ­ç‚¹",
    "lastUpdate": "æœ€åæ›´æ–°"
  },
  "profile": {
    "title": "ç”¨æˆ·é…ç½®",
    "steps": {
      "language": "é€‰æ‹©ç•Œé¢è¯­è¨€",
      "region": "é€‰æ‹©æ‚¨å…³æ³¨çš„åœ°åŒº",
      "age": "é€‰æ‹©æ‚¨çš„å¹´é¾„æ®µ",
      "ethnicity": "é€‰æ‹©æ‚¨çš„æ—è£”",
      "scenarios": "é€‰æ‹©æ‚¨æƒ³è¦çš„åœºæ™¯"
    }
  },
  "templates": {
    "POD": {
      "tshirt": "ä¸€æ¬¾é€‚åˆ{trendName}çš„æ½®æµTæ¤è®¾è®¡ï¼Œ{style}ï¼Œ{specs}"
    }
  }
}
```

```json
// locales/en-US.json
{
  "common": {
    "appName": "XTrendAI",
    "loading": "Loading...",
    "error": "Error occurred",
    "copy": "Copy",
    "copied": "Copied"
  },
  "home": {
    "title": "Today's Trends",
    "fetchTrends": "Get Latest Trends",
    "lastUpdate": "Last Updated"
  },
  "profile": {
    "title": "User Profile",
    "steps": {
      "language": "Select Interface Language",
      "region": "Select Your Region",
      "age": "Select Your Age Group",
      "ethnicity": "Select Your Ethnicity",
      "scenarios": "Select Scenarios"
    }
  },
  "templates": {
    "POD": {
      "tshirt": "A trendy t-shirt design for {trendName}, {style}, {specs}"
    }
  }
}
```

### 2.3 components/layout/LanguageSelector.tsx

è¯­è¨€åˆ‡æ¢ç»„ä»¶ï¼š

```typescript
// components/layout/LanguageSelector.tsx
export function LanguageSelector() {
  const { locale, setLocale } = useI18n()

  return (
    <Select value={locale} onValueChange={setLocale}>
      <SelectTrigger>
        <SelectValue />
      </SelectTrigger>
      <SelectContent>
        <SelectItem value="zh-CN">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</SelectItem>
        <SelectItem value="en-US">ğŸ‡ºğŸ‡¸ English</SelectItem>
      </SelectContent>
    </Select>
  )
}
```

### 2.4 services/I18nService.ts

å›½é™…åŒ–æœåŠ¡ï¼š

```typescript
// services/I18nService.ts
export class I18nService {
  /**
   * æ£€æµ‹è¯·æ±‚è¯­è¨€
   */
  static detectLanguage(request: Request): string {
    // 1. æ£€æŸ¥Cookie
    const cookieLang = this.getLanguageFromCookie(request)
    if (cookieLang) return cookieLang

    // 2. æ£€æŸ¥Accept-Languageå¤´
    const acceptLang = this.getLanguageFromHeader(request)
    if (acceptLang) return acceptLang

    // 3. è¿”å›é»˜è®¤è¯­è¨€
    return 'zh-CN'
  }

  /**
   * è·å–ä»»åŠ¡è¾“å‡ºè¯­è¨€ï¼ˆæ··åˆç­–ç•¥ï¼‰
   */
  static getOutputLanguage(
    scenario: Scenario,
    interfaceLang: string
  ): string {
    // PODåœºæ™¯å§‹ç»ˆä½¿ç”¨è‹±æ–‡
    if (scenario === 'POD') return 'en-US'

    // å†…å®¹åˆ›ä½œä½¿ç”¨ç•Œé¢è¯­è¨€
    if (scenario === 'CONTENT') return interfaceLang

    // è¥é”€åœºæ™¯æ ¹æ®ç›®æ ‡å¸‚åœº
    if (scenario === 'MARKETING') {
      // å¯ä»¥æ ¹æ®ç”¨æˆ·é€‰æ‹©çš„åœ°åŒºå†³å®š
      return interfaceLang
    }

    return interfaceLang
  }

  /**
   * è·å–ç¿»è¯‘åçš„ä»»åŠ¡æ¨¡æ¿
   */
  static getTaskTemplate(
    scenario: string,
    taskType: string,
    outputLang: string
  ): string {
    const templates = outputLang === 'zh-CN'
      ? zhCNTranslations.templates
      : enUSTranslations.templates

    return templates[scenario][taskType]
  }
}
```

### 2.5 hooks/useI18n.ts

å›½é™…åŒ–Hookï¼š

```typescript
// hooks/useI18n.ts
export function useI18n() {
  const [locale, setLocale] = useState<string>('zh-CN')

  const t = (key: string, params?: Record<string, string>) => {
    // è·å–ç¿»è¯‘å¹¶æ›¿æ¢å‚æ•°
    return getTranslation(key, locale, params)
  }

  const switchLanguage = (newLocale: string) => {
    setLocale(newLocale)
    document.cookie = `lang=${newLocale};path=/;max-age=31536000`
    // åˆ·æ–°é¡µé¢æˆ–æ›´æ–°è·¯ç”±
  }

  return {
    locale,
    setLocale: switchLanguage,
    t
  }
}
```

### 2.6 config/i18n.ts

å›½é™…åŒ–é…ç½®ï¼š

```typescript
// config/i18n.ts
export const i18nConfig = {
  // é»˜è®¤è¯­è¨€
  defaultLocale: 'zh-CN',

  // æ”¯æŒçš„è¯­è¨€
  locales: ['zh-CN', 'en-US'] as const,

  // è¯­è¨€åç§°æ˜ å°„
  localeNames: {
    'zh-CN': 'ç®€ä½“ä¸­æ–‡',
    'en-US': 'English'
  },

  // è¯­è¨€æ ‡å¿—
  localeFlags: {
    'zh-CN': 'ğŸ‡¨ğŸ‡³',
    'en-US': 'ğŸ‡ºğŸ‡¸'
  }
} as const

export type Locale = typeof i18nConfig.locales[number]
```

### 2.7 wrappers/ - ç¬¬ä¸‰æ–¹æ¥å£å°è£…å±‚

**è®¾è®¡ç›®çš„**: å°†ç¬¬ä¸‰æ–¹APIè°ƒç”¨é€»è¾‘ä¸ä¸šåŠ¡æœåŠ¡åˆ†ç¦»ï¼Œæé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æµ‹è¯•æ€§ã€‚

```
services/ (ä¸šåŠ¡é€»è¾‘å±‚)
    â”‚ è°ƒç”¨
    â–¼
wrappers/ (æ¥å£å°è£…å±‚)
    â”‚ è°ƒç”¨
    â–¼
ç¬¬ä¸‰æ–¹API (X API, MCPæœåŠ¡)
```

#### wrappers/BaseWrapper.ts

åŸºç¡€å°è£…ç±»ï¼Œæä¾›é€šç”¨åŠŸèƒ½ï¼š

```typescript
// wrappers/BaseWrapper.ts
export abstract class BaseWrapper<T> {
  protected config: T
  protected retryCount: number = 3
  protected timeout: number = 10000

  constructor(config: T) {
    this.config = config
  }

  /**
   * å¸¦é‡è¯•çš„è¯·æ±‚æ–¹æ³•
   */
  protected async fetchWithRetry<R>(
    fn: () => Promise<R>,
    context: string
  ): Promise<R> {
    let lastError: Error

    for (let i = 0; i < this.retryCount; i++) {
      try {
        return await fn()
      } catch (error) {
        lastError = error as Error
        console.warn(`[${context}] è¯·æ±‚å¤±è´¥ï¼Œé‡è¯• ${i + 1}/${this.retryCount}`)

        if (i < this.retryCount - 1) {
          await this.delay(1000 * (i + 1)) // æŒ‡æ•°é€€é¿
        }
      }
    }

    throw new Error(`[${context}] è¯·æ±‚å¤±è´¥: ${lastError!.message}`)
  }

  /**
   * å¸¦è¶…æ—¶çš„è¯·æ±‚æ–¹æ³•
   */
  protected async fetchWithTimeout<R>(
    fn: () => Promise<R>,
    timeout: number = this.timeout
  ): Promise<R> {
    return Promise.race([
      fn(),
      new Promise<never>((_, reject) =>
        setTimeout(() => reject(new Error('è¯·æ±‚è¶…æ—¶')), timeout)
      )
    ])
  }

  protected delay(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms))
  }
}
```

#### wrappers/XApiWrapper.ts

X(Twitter) APIå°è£…ï¼š

```typescript
// wrappers/XApiWrapper.ts
import { BaseWrapper } from './BaseWrapper'

interface XApiConfig {
  apiKey: string
  apiSecret: string
  bearerToken: string
  baseUrl: string
}

export interface XApiTrend {
  name: string
  url: string
  promoted_content: number
  query: string
  tweet_volume: number
}

export class XApiWrapper extends BaseWrapper<XApiConfig> {
  constructor(config?: XApiConfig) {
    super(config || {
      apiKey: process.env.X_API_KEY || '',
      apiSecret: process.env.X_API_SECRET || '',
      bearerToken: process.env.X_BEARER_TOKEN || '',
      baseUrl: 'https://api.twitter.com/2'
    })
  }

  /**
   * è·å–è¶‹åŠ¿åˆ—è¡¨
   * @param woeid Yahooå¤©æ°”IDï¼Œ1=å…¨çƒ
   */
  async getTrends(woeid: number = 1): Promise<XApiTrend[]> {
    return this.fetchWithRetry(async () => {
      const response = await fetch(
        `${this.config.baseUrl}/trends/place.json?id=${woeid}`,
        {
          headers: {
            'Authorization': `Bearer ${this.config.bearerToken}`
          }
        }
      )

      if (!response.ok) {
        throw new Error(`X APIé”™è¯¯: ${response.status}`)
      }

      const data = await response.json()
      return data[0]?.trends || []
    }, 'XApiWrapper.getTrends')
  }

  /**
   * æ ¹æ®åœ°åŒºè·å–è¶‹åŠ¿
   */
  async getTrendsByRegion(region: string): Promise<XApiTrend[]> {
    const woeidMap: Record<string, number> = {
      'us': 23424977,     // ç¾å›½
      'cn': 23424781,     // ä¸­å›½
      'uk': 23424975,     // è‹±å›½
      'jp': 23424856,     // æ—¥æœ¬
      'global': 1        // å…¨çƒ
    }

    const woeid = woeidMap[region] ?? 1
    return this.getTrends(woeid)
  }
}
```

#### wrappers/MCPWrapper.ts

MCPæœåŠ¡å°è£…ï¼š

```typescript
// wrappers/MCPWrapper.ts
import { BaseWrapper } from './BaseWrapper'

export interface MCPTrend {
  id: string
  name: string
  volume: number
  growthRate: number
  category: string
}

export class MCPWrapper extends BaseWrapper<{ serverUrl: string }> {
  constructor(config?: { serverUrl?: string }) {
    super({
      serverUrl: config?.serverUrl || process.env.MCP_SERVER_URL || ''
    })
  }

  /**
   * ä»MCPæœåŠ¡è·å–çƒ­ç‚¹æ•°æ®
   */
  async getTrends(): Promise<MCPTrend[]> {
    return this.fetchWithRetry(async () => {
      const response = await fetch(`${this.config.serverUrl}/trends`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ limit: 20 })
      })

      if (!response.ok) {
        throw new Error(`MCPæœåŠ¡é”™è¯¯: ${response.status}`)
      }

      return response.json()
    }, 'MCPWrapper.getTrends')
  }
}
```

#### wrappers/MockWrapper.ts

æ¨¡æ‹Ÿæ•°æ®å°è£…ï¼ˆMVPé˜¶æ®µä½¿ç”¨ï¼‰ï¼š

```typescript
// wrappers/MockWrapper.ts
import { BaseWrapper } from './BaseWrapper'
import mockTrends from '@/data/mock-trends.json'

export class MockWrapper extends BaseWrapper<Record<string, never>> {
  constructor() {
    super({})
  }

  /**
   * è·å–æ¨¡æ‹Ÿçƒ­ç‚¹æ•°æ®
   */
  async getTrends(): Promise<any[]> {
    // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
    await this.delay(500)

    // è¿”å›æ¨¡æ‹Ÿæ•°æ®
    return mockTrends.trends || []
  }

  /**
   * æ ¹æ®åœ°åŒºç­›é€‰æ¨¡æ‹Ÿæ•°æ®
   */
  async getTrendsByRegion(region: string): Promise<any[]> {
    await this.delay(500)

    const allTrends = mockTrends.trends || []

    // å¦‚æœæ˜¯globalæˆ–é€‰æ‹©globalï¼Œè¿”å›æ‰€æœ‰
    if (region === 'global') {
      return allTrends
    }

    // å¦åˆ™ç­›é€‰åŒ…å«è¯¥åœ°åŒºçš„çƒ­ç‚¹
    return allTrends.filter((trend: any) =>
      trend.isPublic || trend.regions?.includes(region)
    )
  }
}
```

#### wrappers/index.ts

ç»Ÿä¸€å¯¼å‡ºï¼š

```typescript
// wrappers/index.ts
export { BaseWrapper } from './BaseWrapper'
export { XApiWrapper } from './XApiWrapper'
export { MCPWrapper } from './MCPWrapper'
export { MockWrapper } from './MockWrapper'

// å·¥å‚å‡½æ•°ï¼šæ ¹æ®ç¯å¢ƒåˆ›å»ºå¯¹åº”çš„Wrapper
export function createTrendWrapper() {
  if (process.env.NODE_ENV === 'production' && process.env.X_API_KEY) {
    return new XApiWrapper()
  }

  if (process.env.MCP_SERVER_URL) {
    return new MCPWrapper()
  }

  // é»˜è®¤ä½¿ç”¨Mockæ•°æ®
  return new MockWrapper()
}
```

#### æœåŠ¡å±‚è°ƒç”¨Wrapper

```typescript
// services/TrendService.ts
import { createTrendWrapper } from '@/wrappers'

export class TrendService {
  private wrapper = createTrendWrapper()

  async getTrends(region: string): Promise<Trend[]> {
    // è°ƒç”¨Wrapperè·å–åŸå§‹æ•°æ®
    const rawTrends = await this.wrapper.getTrendsByRegion(region)

    // ä¸šåŠ¡é€»è¾‘å¤„ç†
    return this.processTrends(rawTrends)
  }

  private processTrends(rawTrends: any[]): Trend[] {
    // ä¸šåŠ¡é€»è¾‘ï¼šæ ‡å‡†åŒ–ã€ç­›é€‰ã€æ’åºç­‰
    return rawTrends.map(t => ({
      id: `trend-${Date.now()}-${Math.random()}`,
      name: t.name,
      volume: t.volume || 0,
      growthRate: t.growthRate || 0,
      // ...
    }))
  }
}
```

#### Wrapperå±‚ä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|-----|------|
| **å…³æ³¨ç‚¹åˆ†ç¦»** | ä¸šåŠ¡é€»è¾‘ä¸APIè°ƒç”¨åˆ†ç¦» |
| **æ˜“äºæµ‹è¯•** | å¯è½»æ¾Mock Wrapperè¿›è¡Œå•å…ƒæµ‹è¯• |
| **ç»Ÿä¸€é”™è¯¯å¤„ç†** | é‡è¯•ã€è¶…æ—¶ã€é™æµé›†ä¸­åœ¨BaseWrapper |
| **æ˜“äºæ›¿æ¢** | åˆ‡æ¢æ•°æ®æºåªéœ€ä¿®æ”¹å·¥å‚å‡½æ•° |
| **æ—¥å¿—ç›‘æ§** | é›†ä¸­è®°å½•ç¬¬ä¸‰æ–¹APIè°ƒç”¨æ—¥å¿— |

---

## 3. æ–‡ä»¶å‘½åè§„èŒƒ

### 3.1 ç»„ä»¶æ–‡ä»¶

| è§„åˆ™ | ç¤ºä¾‹ | è¯´æ˜ |
|-----|------|------|
| PascalCase | `HotspotCard.tsx` | Reactç»„ä»¶ |
| kebab-caseç›®å½• | `hotspot/` | ç»„ä»¶ç›®å½• |
| index.tså¯¼å‡º | `components/index.ts` | ç»Ÿä¸€å¯¼å‡ºå…¥å£ |

### 3.2 å·¥å…·/æœåŠ¡æ–‡ä»¶

| è§„åˆ™ | ç¤ºä¾‹ | è¯´æ˜ |
|-----|------|------|
| PascalCase + Serviceåç¼€ | `I18nService.ts` | æœåŠ¡ç±» |
| camelCase | `utils.ts` | å·¥å…·å‡½æ•° |
| kebab-case | `use-i18n.ts` | Hooks (ä¹Ÿå¯ç”¨camelCase `useI18n.ts`) |

### 3.3 ç±»å‹æ–‡ä»¶

| è§„åˆ™ | ç¤ºä¾‹ | è¯´æ˜ |
|-----|------|------|
| camelCase | `i18n.ts` | ç±»å‹å®šä¹‰æ–‡ä»¶ |

---

## 4. å¯¼å…¥ç»„ç»‡è§„èŒƒ

### 4.1 å¯¼å…¥é¡ºåº

```typescript
// 1. å¤–éƒ¨ä¾èµ–
import { useState } from 'react'
import { Button } from '@/components/ui/button'

// 2. å›½é™…åŒ–
import { useI18n } from '@/hooks/useI18n'
import { I18nService } from '@/services/I18nService'

// 3. å†…éƒ¨ç»„ä»¶
import { HotspotCard } from '@/components/hotspot/HotspotCard'

// 4. æœåŠ¡å±‚
import { TrendService } from '@/services/TrendService'

// 5. ç±»å‹
import type { UserProfile, Locale } from '@/types'

// 6. å·¥å…·å‡½æ•°
import { formatNumber } from '@/lib/format'

// 7. CSS
import './HotspotList.css'
```

### 4.2 è·¯å¾„åˆ«å

```typescript
// tsconfig.json
{
  "compilerOptions": {
    "paths": {
      "@/*": ["./*"],
      "@/components/*": ["./components/*"],
      "@/lib/*": ["./lib/*"],
      "@/services/*": ["./services/*"],
      "@/types/*": ["./types/*"],
      "@/hooks/*": ["./hooks/*"],
      "@/data/*": ["./data/*"],
      "@/locales/*": ["./locales/*"],
      "@/config/*": ["./config/*"]
    }
  }
}
```

---

## 5. ä»£ç ç»„ç»‡åŸåˆ™

### 5.1 å•ä¸€èŒè´£

æ¯ä¸ªæ–‡ä»¶/æ¨¡å—åªè´Ÿè´£ä¸€ä»¶äº‹ï¼š
- ç»„ä»¶æ–‡ä»¶åªåŒ…å«UIé€»è¾‘
- æœåŠ¡æ–‡ä»¶åªåŒ…å«ä¸šåŠ¡é€»è¾‘
- ç±»å‹æ–‡ä»¶åªåŒ…å«ç±»å‹å®šä¹‰
- ç¿»è¯‘æ–‡ä»¶åªåŒ…å«ç¿»è¯‘å†…å®¹

### 5.2 ä¾èµ–æ–¹å‘

```
é¡µé¢ (app/[locale]/)
  â†“ ä¾èµ–
ç»„ä»¶ (components/)
  â†“ ä¾èµ–
Hooks (hooks/) + æœåŠ¡ (services/)
  â†“ ä¾èµ–
å°è£…å±‚ (wrappers/) + å­˜å‚¨ (stores/) + ç±»å‹ (types/) + ç¿»è¯‘ (locales/)
  â†“ ä¾èµ–
å·¥å…· (lib/) + é…ç½® (config/)
                    â†“
            ç¬¬ä¸‰æ–¹API (X API, MCPæœåŠ¡)
```

### 5.3 å›½é™…åŒ–èµ„æºç»„ç»‡

- ç¿»è¯‘æ–‡ä»¶æŒ‰è¯­è¨€åˆ†ç¦»
- ä»»åŠ¡æ¨¡æ¿åŒ…å«åœ¨ç¿»è¯‘æ–‡ä»¶ä¸­
- æ”¯æŒå‚æ•°æ’å€¼ `{variable}`
- æ”¯æŒåµŒå¥—å‘½åç©ºé—´

---

## 6. MVPç®€åŒ–ç»“æ„ (V1.0)

å¯¹äº8å°æ—¶å¿«é€Ÿäº¤ä»˜ï¼Œå¯ä»¥ç®€åŒ–éƒ¨åˆ†ç›®å½•ï¼š

```
ç®€åŒ–ç‰ˆç»“æ„ (V1.0 MVP)
â”œâ”€â”€ app/                    # é¡µé¢+API (å«[locale]è·¯ç”±)
â”œâ”€â”€ components/             # ç»„ä»¶ (å®Œæ•´)
â”œâ”€â”€ services/               # æœåŠ¡ (ç®€åŒ–ï¼Œåˆå¹¶éƒ¨åˆ†é€»è¾‘)
â”œâ”€â”€ wrappers/               # ç¬¬ä¸‰æ–¹å°è£… (ä»…éœ€MockWrapper) â† æ–°å¢
â”œâ”€â”€ lib/                    # å·¥å…· (å®Œæ•´)
â”œâ”€â”€ locales/                # ç¿»è¯‘èµ„æº (å®Œæ•´)
â”œâ”€â”€ types/                  # ç±»å‹ (ç®€åŒ–ï¼Œåˆå¹¶åˆ°å„æ–‡ä»¶)
â”œâ”€â”€ data/                   # é™æ€æ•°æ® (å®Œæ•´)
â”œâ”€â”€ hooks/                  # Hooks (ç®€åŒ–)
â”œâ”€â”€ config/                 # é…ç½® (å®Œæ•´)
â””â”€â”€ stores/                 # å­˜å‚¨ (ä½¿ç”¨JSONæ–‡ä»¶)

æš‚ä¸åˆ›å»º:
â”œâ”€â”€ middleware/             # V1.0åœ¨APIå±‚ç®€å•å¤„ç†ï¼Œi18nåœ¨layoutå¤„ç†
â”œâ”€â”€ styles/                 # ä½¿ç”¨Tailwind
â””â”€â”€ å¤æ‚çš„ç¼“å­˜å±‚            # V1.0ä½¿ç”¨ç®€å•å†…å­˜ç¼“å­˜
```

---

## 7. å›½é™…åŒ–å¼€å‘æ³¨æ„äº‹é¡¹

### 7.1 ç»„ä»¶ä¸­ä½¿ç”¨ç¿»è¯‘

```typescript
// âœ… æ¨èï¼šä½¿ç”¨Hook
function HotspotCard() {
  const { t } = useI18n()
  return <div>{t('home.title')}</div>
}

// âœ… æœåŠ¡ç«¯ç»„ä»¶ï¼šä½¿ç”¨æœåŠ¡ç«¯ç¿»è¯‘å‡½æ•°
async function HotspotList() {
  const t = await getTranslations('home')
  return <div>{t('title')}</div>
}
```

### 7.2 æ·»åŠ æ–°ç¿»è¯‘æ­¥éª¤

1. åœ¨ `locales/zh-CN.json` æ·»åŠ ä¸­æ–‡ç¿»è¯‘
2. åœ¨ `locales/en-US.json` æ·»åŠ è‹±æ–‡ç¿»è¯‘
3. ç»„ä»¶ä¸­ä½¿ç”¨ `t('key')` å¼•ç”¨

### 7.3 ä»»åŠ¡æ¨¡æ¿ç¿»è¯‘

ä»»åŠ¡æ¨¡æ¿éœ€è¦åœ¨ä¸¤ç§è¯­è¨€ä¸­ä¿æŒä¸€è‡´çš„å‚æ•°ç»“æ„ï¼š

```json
// zh-CN.json
"templates": {
  "POD": {
    "tshirt": "ä¸€æ¬¾é€‚åˆ{trendName}çš„æ½®æµTæ¤è®¾è®¡ï¼Œ{style}ï¼Œ{specs}"
  }
}

// en-US.json - å‚æ•°åå¿…é¡»ä¸€è‡´
"templates": {
  "POD": {
    "tshirt": "A trendy t-shirt design for {trendName}, {style}, {specs}"
  }
}
```

---

*æ–‡æ¡£ç‰ˆæœ¬: v2.2*
*åˆ›å»ºæ—¥æœŸ: 2026-02-26*
*æœ€åæ›´æ–°: 2026-02-27 (æ–°å¢wrappersç¬¬ä¸‰æ–¹æ¥å£å°è£…å±‚)*
*è´Ÿè´£äºº: ç³»ç»Ÿæ¶æ„å¸ˆ*
