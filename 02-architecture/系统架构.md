# XTrendAI 系统架构设计 v2.2

## 1. 架构概览

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              XTrendAI 系统架构                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                           前端层 (Frontend)                            │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │  │
│  │  │   首页       │  │  配置页面    │  │  结果页面    │                │  │
│  │  │  (热点展示)  │  │ (用户画像)   │  │  (任务列表)  │                │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘                │  │
│  │                                    │                                  │  │
│  │  ┌────────────────────────────────────────────────────────────────┐  │  │
│  │  │                     共享组件层 (Components)                     │  │
│  │  │  HotspotCard / TaskCard / CopyButton / UserProfile / ...      │  │
│  │  └────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                    │  │
│  │  ┌────────────────────────────────────────────────────────────────┐  │  │
│  │  │                     国际化层 (i18n)                            │  │
│  │  │  语言检测 / 语言切换 / 翻译资源 / 混合语言策略                  │  │
│  │  └────────────────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                      │                                      │
│                                      ▼                                      │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                          API网关层 (Next.js API Routes)               │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │  │
│  │  │  鉴权中间件  │  │  限流中间件  │  │  日志中间件  │                │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘                │  │
│  │  ┌──────────────┐                                                  │  │
│  │  │  语言中间件  │  解析请求语言，设置上下文                          │  │
│  │  └──────────────┘                                                  │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                      │                                      │
│                                      ▼                                      │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                          业务逻辑层 (Services)                        │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │  │
│  │  │ 热点采集服务 │  │ 筛选引擎服务 │  │ 任务生成服务 │                │  │
│  │  │ (TrendService)│(FilterService)│(TaskService)  │                │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘                │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │  │
│  │  │ 用户服务     │  │ 配额管理服务 │  │ 国际化服务   │                │  │
│  │  │(UserService) │(QuotaService)  │(I18nService)   │                │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘                │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                      │                                      │
│                                      ▼                                      │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                        第三方接口封装层 (Wrappers)                     │  │
│  │  职责：直接调用外部第三方 API，而非内部代理端点                         │  │
│  │  XApiWrapper → https://api.twitter.com (直接)                         │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │  │
│  │  │ XApiWrapper  │  │  MCPWrapper  │  │  MockWrapper  │                │  │
│  │  │  (X API封装) │  │ (MCP封装)   │  │ (模拟数据)   │                │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘                │  │
│  │  ┌────────────────────────────────────────────────────────────────┐  │  │
│  │  │               BaseWrapper (重试/超时/日志)                      │  │
│  │  └────────────────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                      │                                      │
│                                      ▼                                      │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                          数据访问层 (Data Access)                     │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │  │
│  │  │  用户存储    │  │  热点缓存    │  │  模板存储    │                │  │
│  │  │ (UserStore)  │  │ (TrendCache) │  │(TemplateStore)│                │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘                │  │
│  │  ┌──────────────┐                                                  │  │
│  │  │  翻译资源    │  locales/zh-CN.json, locales/en-US.json           │  │
│  │  └──────────────┘                                                  │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                      │                                      │
│                                      ▼                                      │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                        外部数据源 (Data Sources)                      │  │
│  │  ┌──────────────┐  ┌──────────────┐                                  │  │
│  │  │  X API       │  │  MCP服务     │                                  │  │
│  │  │  (V2.0)      │  │  (备选)      │                                  │  │
│  │  └──────────────┘  └──────────────┘                                  │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 分层说明

| 层级 | 职责 | 技术 |
|-----|------|------|
| 前端层 | 用户界面、交互、状态管理 | Next.js + React + Tailwind |
| 国际化层 | 多语言支持、语言切换、翻译资源 | next-intl |
| API网关层 | 请求路由、鉴权、限流、语言处理 | Next.js API Routes |
| 业务逻辑层 | 核心业务处理、多语言任务生成 | TypeScript Services |
| **接口封装层** | **第三方API调用、重试、超时、日志** | **TypeScript Wrappers** |
| 数据访问层 | 数据持久化、缓存、翻译资源 | JSON/SQLite (MVP) |
| 外部数据源 | 热点数据获取 | X API (V2.0) / MCP服务 |

---

## 2. 国际化架构 (i18n)

### 2.1 国际化模块设计

```
┌─────────────────────────────────────────────────────────────────┐
│                      国际化模块 (i18n)                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   语言检测层                              │   │
│  │  浏览器语言检测 → Cookie读取 → 手动选择                   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                          │                                     │
│                          ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   翻译资源层                              │   │
│  │  ┌──────────────────┐    ┌──────────────────┐           │   │
│  │  │ locales/zh-CN.json│    │ locales/en-US.json│           │   │
│  │  │ - 界面翻译        │    │ - 界面翻译        │           │   │
│  │  │ - 任务模板(中文)  │    │ - 任务模板(英文)  │           │   │
│  │  └──────────────────┘    └──────────────────┘           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                          │                                     │
│                          ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   混合语言策略                            │   │
│  │  ┌─────────────────────────────────────────────────┐   │   │
│  │  │ 场景        │ 界面语言 │ 任务输出语言 │ 原因      │   │   │
│  │  │ POD         │ 中/英    │ 英文         │ AI工具支持│   │   │
│  │  │ 内容创作    │ 中文     │ 中文         │ 本地使用  │   │   │
│  │  │ 营销        │ 中/英    │ 混合         │ 灵活适应  │   │   │
│  │  └─────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 支持的语言

| 语言 | 代码 | 界面支持 | 任务输出 |
|-----|------|---------|---------|
| 中文 | `zh-CN` | ✓ | ✓ |
| 英文 | `en-US` | ✓ | ✓ |

### 2.3 语言切换流程

```
用户访问 → 检测浏览器语言 → 设置默认语言 → 保存到Cookie
                                                          │
                         用户手动切换 ←────────────────────┘
                                │
                                ▼
                          更新Cookie
                                │
                                ▼
                          重新渲染界面
                                │
                                ▼
                          后续请求携带语言头
```

---

## 3. 技术选型

### 3.1 前端技术栈

| 技术 | 版本 | 选型理由 |
|-----|------|---------|
| **框架** | Next.js 15 | App Router、服务端组件、全栈一体化 |
| **UI库** | shadcn/ui | 现代设计、组件丰富、可定制性强 |
| **样式** | Tailwind CSS | 快速开发、响应式、一致性 |
| **国际化** | next-intl | Next.js官方推荐，支持App Router |
| **状态管理** | React Hooks + Context | MVP阶段足够，轻量简洁 |
| **表单处理** | React Hook Form | 性能优秀、API友好 |
| **HTTP客户端** | Fetch API | 原生支持，无需额外依赖 |

### 3.2 后端技术栈

| 技术 | 版本 | 选型理由 |
|-----|------|---------|
| **运行时** | Node.js 20+ | LTS稳定版本 |
| **API框架** | Next.js API Routes | 与前端一体化，减少复杂度 |
| **语言** | TypeScript 5.3+ | 类型安全、开发体验 |
| **数据存储** | JSON文件 | MVP阶段简单直接 |
| **缓存** | 内存缓存 (Map) | 轻量快速 |

### 3.3 部署技术栈

| 技术 | 选型理由 |
|-----|---------|
| **Vercel** | Next.js官方平台，一键部署，零配置 |
| **环境变量** | .env + Vercel环境变量 | 安全管理配置 |

### 3.4 开发工具

| 工具 | 用途 |
|-----|------|
| ESLint | 代码规范 |
| Prettier | 代码格式化 |
| TypeScript | 类型检查 |
| Git | 版本控制 |

---

## 4. 核心模块设计

### 4.1 热点采集模块

```
┌─────────────────────────────────────────────────────────────┐
│                      热点采集模块                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │  数据源     │    │  数据源     │    │  数据源     │     │
│  │  X API      │    │  MCP服务    │    │  模拟数据   │     │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘     │
│         │                  │                  │             │
│         └──────────────────┼──────────────────┘             │
│                            ▼                                │
│                   ┌───────────────┐                         │
│                   │  数据源适配器  │                         │
│                   │ (DataSource)  │                         │
│                   └───────┬───────┘                         │
│                           ▼                                 │
│                   ┌───────────────┐                         │
│                   │  TrendService │                         │
│                   │  .getTrends() │                         │
│                   └───────┬───────┘                         │
│                           ▼                                 │
│                   ┌───────────────┐                         │
│                   │  标准化格式    │                         │
│                   │  {trends[]}   │                         │
│                   └───────────────┘                         │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 个性化筛选模块

```
┌─────────────────────────────────────────────────────────────┐
│                      个性化筛选模块                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  输入: 原始热点列表 + 用户画像                                │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  FilterService.filter(trends, userProfile)          │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  1. 地区过滤 - 匹配用户选择的地区热点                 │   │
│  │  2. 年龄偏好 - 根据年龄段调整热点权重                │   │
│  │  3. 公共热点合并 - 节假日/赛事始终包含               │   │
│  │  4. 排序 - 热度 + 增长率 + 相关性                    │   │
│  │  5. 限制数量 - 返回前10个                            │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  输出: 筛选后的个性化热点列表                                │
└─────────────────────────────────────────────────────────────┘
```

### 4.3 任务生成模块

```
┌─────────────────────────────────────────────────────────────┐
│                      任务生成模块                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  输入: 筛选后热点 + 用户场景 + 用户语言                       │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  TaskService.generateTasks(trend, scenarios, lang)  │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  场景模板引擎 (根据语言选择模板)                       │   │
│  │  ┌─────────────────────────────────────────────┐   │   │
│  │  │  POD模板库 (双语)                            │   │   │
│  │  │  - T恤设计提示词模板 (zh-CN / en-US)         │   │   │
│  │  │  - 帆布袋设计提示词模板 (zh-CN / en-US)       │   │   │
│  │  │  - 手机壳设计提示词模板 (zh-CN / en-US)       │   │   │
│  │  └─────────────────────────────────────────────┘   │   │
│  │  ┌─────────────────────────────────────────────┐   │   │
│  │  │  营销模板库 (双语)                           │   │   │
│  │  │  - 标题模板 (zh-CN / en-US)                 │   │   │
│  │  │  - 描述模板 (zh-CN / en-US)                 │   │   │
│  │  └─────────────────────────────────────────────┘   │   │
│  │  ┌─────────────────────────────────────────────┐   │   │
│  │  │  内容创作模板库 (双语)                       │   │   │
│  │  │  - 视频选题模板 (zh-CN / en-US)             │   │   │
│  │  │  - 脚本大纲模板 (zh-CN / en-US)             │   │   │
│  │  └─────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  输出: 每个热点对应多个场景的任务列表(对应语言)                │
└─────────────────────────────────────────────────────────────┘
```

### 4.4 国际化服务模块

```
┌─────────────────────────────────────────────────────────────┐
│                    I18nService                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  方法                                                │   │
│  │  ─────────────────────────────────────────────────   │   │
│  │  detectLanguage(request)        // 检测请求语言      │   │
│  │  getTranslation(key, lang)      // 获取翻译         │   │
│  │  getTaskTemplate(scenario, lang) // 获取任务模板    │   │
│  │  formatMessage(key, params, lang) // 格式化消息     │   │
│  │  formatDate(date, lang)        // 格式化日期        │   │
│  │  getOutputLanguage(scenario, lang) // 获取输出语言  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  混合语言策略                                         │   │
│  │  ─────────────────────────────────────────────────   │   │
│  │  POD场景        → 始终使用英文提示词                 │   │
│  │  内容创作场景  → 使用界面语言                        │   │
│  │  营销场景      → 根据目标市场混合                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. 数据流设计

### 5.1 完整请求流程 (含语言处理)

```
用户请求                前端                  API层                业务层                数据层
  │                      │                      │                    │                    │
  │  点击"获取热点"       │                      │                    │                    │
  ├─────────────────────>│                      │                    │                    │
  │  (带Cookie: lang=zh-CN)                    │                    │                    │
  │                      │  GET /api/trends     │                    │                    │
  │                      │  Accept-Language: zh-CN                │                    │
  │                      ├─────────────────────>│                    │                    │
  │                      │                      │  语言中间件解析     │                    │
  │                      │                      │  鉴权检查           │                    │
  │                      │                      │  配额检查           │                    │
  │                      │                      │                    │                    │
  │                      │                      │  TrendService.getTrends(lang)         │
  │                      │                      ├───────────────────>│                    │
  │                      │                      │                    │  获取用户画像+语言 │
  │                      │                      │                    ├──────────────────>│
  │                      │                      │                    │<──────────────────┤
  │                      │                      │                    │                    │
  │                      │                      │                    │  获取热点数据      │
  │                      │                      │                    ├──────────────────>│
  │                      │                      │                    │<──────────────────┤
  │                      │                      │                    │                    │
  │                      │                      │                    │  筛选+生成任务(中文)│
  │                      │                      │<───────────────────┤                    │
  │                      │                      │                    │                    │
  │                      │  返回结果(中文)      │                    │                    │
  │                      │<─────────────────────┤                    │                    │
  │  渲染热点列表(中文)   │                      │                    │                    │
  │<─────────────────────┤                      │                    │                    │
```

### 5.2 状态管理 (含语言)

```typescript
// 全局状态结构
interface AppState {
  // 语言状态
  locale: {
    current: 'zh-CN' | 'en-US'
    browser: string
    cookie: string | null
  }

  // 用户状态
  user: {
    id: string
    role: 'guest' | 'free' | 'pro' | 'admin'
    profile: UserProfile | null
    language: string  // 用户偏好语言
  }

  // 热点数据状态
  trends: {
    items: Trend[]
    loading: boolean
    error: string | null
    lastUpdated: Date | null
  }

  // 配额状态
  quota: {
    fetchCount: number
    copyCount: number
    dailyLimit: number
    resetAt: Date | null
  }

  // UI状态
  ui: {
    selectedTrend: string | null
    expandedTasks: Set<string>
    copiedTask: string | null
  }
}
```

---

## 6. 性能考虑

### 6.1 缓存策略

| 数据类型 | 缓存位置 | 缓存时间 | 更新策略 |
|---------|---------|---------|---------|
| 热点数据 | 服务端内存 | 15分钟 | 定时刷新 |
| 用户配置 | LocalStorage | 永久 | 用户更新时 |
| 任务模板 | 代码常量 | - | 部署时更新 |
| 翻译资源 | 内存 + CDN | 永久 | 按需加载 |

### 6.2 优化措施

1. **服务端渲染** - 首页使用SSR，提升首屏加载速度
2. **代码分割** - 按路由分割代码，减小初始加载体积
3. **图片优化** - Next.js Image组件自动优化
4. **API限流** - 防止滥用，保护服务
5. **翻译资源按需加载** - 只加载当前语言的翻译文件

---

## 7. 安全设计

### 7.1 鉴权设计

```
┌─────────────────────────────────────────────────────────────┐
│                         鉴权流程                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  请求 → 鉴权中间件 → Token验证 → 角色检查 → 权限验证 → 处理 │
│                                                             │
│  Guest: 无需登录，有限访问                                   │
│  Free/Pro: JWT Token验证                                    │
│  Admin: JWT + 额外权限检查                                   │
└─────────────────────────────────────────────────────────────┘
```

### 7.2 安全措施

| 措施 | 实现方式 |
|-----|---------|
| XSS防护 | React自动转义 + CSP头 |
| CSRF防护 | SameSite Cookie |
| API限流 | 按用户/IP限流 |
| 敏感数据 | 环境变量存储，不提交代码 |
| 输入验证 | Zod schema验证 |

---

## 8. 部署架构

### 8.1 Vercel部署结构

```
vercel-production/
├── app/                    # Next.js App Router
│   ├── [locale]/          # 国际化路由
│   │   ├── (main)/        # 主要页面组
│   │   └── api/           # API路由
│   ├── layout.tsx         # 根布局
│   └── globals.css        # 全局样式
├── components/            # 共享组件
├── lib/                   # 工具函数
├── locales/               # 翻译资源
│   ├── zh-CN.json
│   └── en-US.json
├── services/              # 业务服务
├── stores/                # 数据存储
└── public/                # 静态资源
```

### 8.2 环境配置

```bash
# .env.production
NEXT_PUBLIC_APP_URL=https://xtrendai.vercel.app
NEXT_PUBLIC_APP_NAME=XTrendAI

# 国际化配置
NEXT_PUBLIC_DEFAULT_LOCALE=zh-CN
NEXT_PUBLIC_SUPPORTED_LOCALES=zh-CN,en-US

# V2.0 需要添加
# X_API_KEY=xxx
# MCP_SERVER_URL=xxx
```

---

## 9. 技术债务与演进路线

### 9.1 MVP阶段 (V1.0)

- [x] 模拟热点数据
- [x] JSON文件存储
- [x] 简单鉴权 (基于Local Storage)
- [x] 中英文双语支持

### 9.2 V2.0 规划

- [ ] 集成X API
- [ ] SQLite数据库
- [ ] JWT完整鉴权
- [ ] 管理后台
- [ ] 更多语言支持 (日语、西班牙语)

### 9.3 V3.0 规划

- [ ] PostgreSQL数据库
- [ ] Redis缓存
- [ ] 队列系统 (热点定时获取)
- [ ] 分布式部署
- [ ] AI翻译生成

---

*文档版本: v2.3*
*创建日期: 2026-02-26*
*最后更新: 2026-02-27 (明确Wrapper层职责边界)*
*负责人: 系统架构师*
